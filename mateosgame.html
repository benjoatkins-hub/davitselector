<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shenron: the Game</title>
  <style>
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:#0b1220;color:#fff}
    .wrap{max-width:980px;margin:24px auto;padding:18px;background:linear-gradient(180deg,#071021 0%,#0f1a2a 100%);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0;color:#fff}
    p.lead{color:#b8c6d1;margin:6px 0 12px}
    canvas{display:block;background:linear-gradient(180deg,#0a1724,#07101b);border-radius:6px;width:100%;height:auto}
    .hud{display:flex;gap:12px;align-items:center;margin-top:12px}
    .btn{background:#1b6bff;padding:8px 12px;border-radius:6px;color:#fff;text-decoration:none;border:none;cursor:pointer;font-weight:700}
    .btn.secondary{background:#2f3f55}
    .muted{color:#9fb0c5}
    .controls{margin-top:12px;color:#cde3ff;font-size:13px}
    .form-controls{margin-top:10px;display:flex;gap:8px;align-items:center}
    .form-controls.hidden{display:none}
    .form-controls .btn{background:#243a56}
    .form-controls .btn.active{background:#ff4757}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Shenron: the Game</h1>
        <p class="lead">Fast Paced Cool DBZ Fun!</p>
      </div>
      <div>
        <button id="resetBtn" class="btn">Restart</button>
        <button id="fullscreenBtn" class="btn secondary">Fullscreen</button>
      </div>
    </header>

    <canvas id="game" width="960" height="540"></canvas>

    <div class="hud">
      <div id="score" class="muted">Score: 0</div>
      <div id="lives" class="muted">Lives: 3</div>
      <div id="health" class="muted">Health: 100%</div>
      <div id="kills" class="muted">Kills: 0</div>
      <div id="coins" class="muted">Coins: 0</div>
      <div id="super" class="muted">Super: No</div>
      <div id="energy" class="muted">Energy: 0%</div>
      <div id="cycle" class="muted">Cycle: 30.0s | Fly: 10.0s</div>
    </div>

    <div class="controls">
      Controls: Move = Arrow keys, Jump = Up, Attack = Z, Energy Blast = X (charge to increase power).<br>
      This prototype includes enemies, pickups, scoring, and simple sound effects. <strong>Reach 50 kills to unlock a mini game!</strong>
    </div>
    <div id="formControls" class="form-controls hidden">
      <button id="formNormal" class="btn">Normal</button>
      <button id="formGod" class="btn">God</button>
      <button id="formUltra" class="btn">Ultra</button>
    </div>
  </div>

  <script>
  // Single-file game prototype
  (function(){
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const LOWER_BAND = H * 0.6; // shared lower-air / ground band

    // Simple audio helper (WebAudio)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function tone(freq, time=0.08, type='sine', gain=0.12){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + time);
    }

    // Game state
    let keys = {};
    let score = 0, lives = 3;
    let coinCount = 0;
    let killCount = 0;
    let killMilestone = 0;
    let superStock = 0; // granted by kill milestones (3 per 100 kills)
    let lastTime = 0;
    let entities = []; // enemies and pickups
    
    // Mini game and transformation
    let miniGameTriggered = false;
    let inMiniGame = false;
    let godMode = false;
    let miniGameBossesKilled = 0;
    let miniGameHP = 10;
    let retryPending = null; // 'god' or 'ultra'
    
    // Ultra Mode
    let ultraModeTriggered = false;
    let inUltraMiniGame = false;
    let ultraMode = false;
    let ultraGameJirenKilled = false;
    let ultraMiniGameHP = 10;
    let ultraReady = false;

    // Jiren unlock/summon
    let jirenUnlocked = false;
    let jirenSummonCooldown = 0;
    let jirenSpawnUsed = false;

    // Form switch unlock
    let formsUnlocked = false;
    
    // Cheat code tracking
    let hackCheatUsed = false;
    let hackOneCheatUsed = false;
    let flyCheatUsed = false;
    let infiniteFly = false;

    // Win screen
    let winGame = false;
    const winImage = new Image();
    winImage.src = 'https://wallpaperaccess.com/full/937686.jpg';

    // Player
    const player = {
      x:120, y:H-120, w:44, h:64, vx:0, vy:0, onGround:false, facing:1,
      energy:0, charging:false, hp:100,
      // flight
      flyTimeMax: 10000, // milliseconds (10s)
      flyTime: 10000
    };

    // Simple physics
    const gravity = 0.9, friction = 0.86;

    // Utility
    function rand(min,max){return Math.random()*(max-min)+min}
    function addKills(count){
      killCount += count;
      killMilestone += count;
      while(killMilestone >= 100){
        killMilestone -= 100;
        superStock += 3;
        tone(920,0.18,'sine',0.18);
      }
    }

    // Visual elements: clouds and boulders
    const clouds = [];
    for(let i=0;i<6;i++){ clouds.push({x: rand(0,W), y: rand(30, H * 0.35), w: rand(80,180), vx: rand(0.05,0.3)}); }
    const boulders = [];
    for(let i=0;i<5;i++){ boulders.push({x: rand(60, W-60), y: rand(LOWER_BAND + 6, H-18), r: rand(8,26)}); }

    // Spawn enemies and pickups
    function spawnEnemy(){
      // limit active enemies to 6
      const activeEnemies = entities.filter(en => en.type === 'enemy').length;
      if(activeEnemies >= 6) return;
      const side = Math.random()>.5?1:-1;
      // decide variant: equal chance for normal, strong, or boss (1/3 each)
      const variants = ['normal','strong','boss'];
      const variant = variants[Math.floor(Math.random()*3)];
      // place enemy on the same vertical band as the player (with small jitter)
      const baseY = player.y + (player.h - 56) / 2;
      const y = baseY + rand(-8, 8);
      const speedRange = variant === 'boss' ? [0.6,1.0] : [0.9,1.6];
      const e = {type:'enemy', variant: variant, x: side>0 ? -40 : W+40, y: y, w:48, h:56, vx: side>0? rand(speedRange[0],speedRange[1]) : rand(-speedRange[1],-speedRange[0]), hp: variant === 'boss' ? 5 : (variant === 'strong' ? 3 : 1)};
      entities.push(e);
    }
    function spawnPickup(x,y){
      // spawn a coin at given position or randomly on-screen; clamp to visible area so it's always reachable
      const minX = 60, maxX = W - 60;
      const minY = 80, maxY = LOWER_BAND - 48;
      let px = (typeof x === 'number') ? x : rand(minX, maxX);
      let py = (typeof y === 'number') ? y : rand(minY, maxY);
      px = Math.max(minX, Math.min(maxX, px));
      py = Math.max(minY, Math.min(maxY, py));
      const p = {type:'pickup', kind:'coin', x: px - 9, y: py - 9, w:18, h:18, value:1};
      entities.push(p);
    }

    function startGodMiniGame(){
      miniGameTriggered = true;
      inMiniGame = true;
      retryPending = null;
      miniGameBossesKilled = 0;
      player.hp = 10;
      entities = []; // clear all enemies
      // Spawn 5 bosses
      for(let i=0; i<5; i++){
        const x = 150 + i * 150;
        const y = H * 0.5 + (i % 2 === 0 ? -20 : 20);
        entities.push({type:'enemy', variant:'boss', x:x, y:y, w:48, h:56, vx: (i%2===0?0.8:-0.8), hp:5});
      }
      tone(120, 0.5, 'sawtooth', 0.2);
    }

    function startUltraMiniGame(){
      ultraModeTriggered = true;
      inUltraMiniGame = true;
      retryPending = null;
      ultraGameJirenKilled = false;
      player.hp = 10;
      entities = []; // clear all enemies
      // Spawn 1 Jiren (use boss variant but mark as jiren)
      entities.push({type:'enemy', variant:'jiren', x: W/2, y: H*0.4, w:48, h:56, vx: 0.5, hp:10});
      tone(120, 0.5, 'sawtooth', 0.2);
    }

    // Input
    window.addEventListener('keydown', e=>{ 
      keys[e.key.toLowerCase()] = true; 
      if(e.key===' '){ e.preventDefault(); }
      // jump on Up (allow mid-air if flyTime available)
      if(e.key === 'ArrowUp'){
        if(player.onGround || player.flyTime > 0){
          player.vy = -12; player.onGround = false; tone(300,0.06,'sine',0.06);
          if(!player.onGround) player.flyTime = Math.max(0, player.flyTime - 120);
        }
      }
      // deploy super blast via R
      if(e.key.toLowerCase() === 'r'){
        if(superStock > 0){
          const power = 18;
          const superProj = {type:'super', x:player.x + player.w/2 + (player.facing>0?28:-28), y:player.y+22, w:32, h:16, vx: player.facing * (8 + power*0.6), power, hitsRemaining: 6, lifespan: 3500, created: Date.now()};
          entities.push(superProj);
          superStock = Math.max(0, superStock - 1);
          tone(420,0.32,'sawtooth',0.16);
        }
      }
      // board-clear super via T (costs 5 superStock)
      if(e.key.toLowerCase() === 't'){
        if(superStock >= 5){
          let removed = 0;
          for(let i = entities.length - 1; i >= 0; i--){
            if(entities[i] && entities[i].type === 'enemy'){
              entities.splice(i,1);
              removed += 1;
              score += 60;
              if(!inMiniGame && !inUltraMiniGame) addKills(1);
            }
          }
          superStock = Math.max(0, superStock - 5);
          // feedback
          tone(80,0.5,'sawtooth',0.18);
          flashTimer = 400;
        }
      }
    });
    window.addEventListener('keyup', e=>{ keys[e.key.toLowerCase()] = false; });

    document.getElementById('resetBtn').addEventListener('click', resetGame);
    document.getElementById('fullscreenBtn').addEventListener('click', ()=>{
      if(!document.fullscreenElement){
        if(canvas.requestFullscreen){
          canvas.requestFullscreen();
        }
      } else if(document.exitFullscreen){
        document.exitFullscreen();
      }
    });

    const formControls = document.getElementById('formControls');
    const formNormal = document.getElementById('formNormal');
    const formGod = document.getElementById('formGod');
    const formUltra = document.getElementById('formUltra');

    function setForm(mode){
      if(mode === 'normal'){
        godMode = false;
        ultraMode = false;
      } else if(mode === 'god'){
        godMode = true;
        ultraMode = false;
      } else if(mode === 'ultra'){
        godMode = true;
        ultraMode = true;
      }
      formNormal.classList.toggle('active', mode === 'normal');
      formGod.classList.toggle('active', mode === 'god');
      formUltra.classList.toggle('active', mode === 'ultra');
    }

    formNormal.addEventListener('click', ()=>{ if(formsUnlocked && !winGame) setForm('normal'); });
    formGod.addEventListener('click', ()=>{ if(formsUnlocked && !winGame) setForm('god'); });
    formUltra.addEventListener('click', ()=>{ if(formsUnlocked && !winGame) setForm('ultra'); });

    function resetGame(){
      score = 0; lives = 3;
      player.x = 120;
      player.y = (H * 0.6) - player.h; // start in the lower air band
      player.vx = 0; player.vy = 0; player.onGround = false;
      player.energy = 0; player.flyTime = player.flyTimeMax;
      cycleTimer = 0;
      entities = [];
      coinCount = 0; killCount = 0; killMilestone = 0; superStock = 0;
      miniGameTriggered = false; inMiniGame = false; godMode = false;
      miniGameBossesKilled = 0;
      ultraModeTriggered = false; inUltraMiniGame = false; ultraMode = false;
      ultraGameJirenKilled = false;
      retryPending = null;
      infiniteFly = false;
      jirenUnlocked = false;
      jirenSummonCooldown = 0;
      formsUnlocked = false;
    }

    // Simple rectangle collision
    function collide(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y; }

    // Draw player (original art: stylized fighter)
    function drawPlayer(p){
      ctx.save();
      // charging aura
      if(p.charging){ ctx.globalAlpha = 0.18; ctx.fillStyle = '#ffd86b'; ctx.beginPath(); ctx.ellipse(p.x+p.w/2, p.y+p.h/2, 48 + p.energy*0.2, 72 + p.energy*0.25, 0, 0, Math.PI*2); ctx.fill(); }

      // pants / lower robe
      ctx.fillStyle = '#ff8c1a'; ctx.fillRect(p.x+6, p.y+28, p.w-12, p.h-20);
      // sash
      ctx.fillStyle = '#b24d00'; ctx.fillRect(p.x+8, p.y+42, p.w-16, 8);

      // gi torso (orange) and blue undershirt (V-neck)
      ctx.fillStyle = '#ff8c1a'; ctx.fillRect(p.x+6, p.y+12, p.w-12, 28);
      ctx.fillStyle = '#0b5bd6'; ctx.beginPath(); ctx.moveTo(p.x + p.w/2, p.y + 18); ctx.lineTo(p.x + 10, p.y + 38); ctx.lineTo(p.x + p.w - 10, p.y + 38); ctx.closePath(); ctx.fill();

      // sleeves
      ctx.fillStyle = '#ff8c1a'; ctx.fillRect(p.x-6, p.y+28, 14, 12); ctx.fillRect(p.x+p.w-8, p.y+28, 14, 12);

      // boots
      ctx.fillStyle = '#2b6bff'; ctx.fillRect(p.x+6, p.y+p.h-12, 14, 8); ctx.fillRect(p.x+p.w-20, p.y+p.h-12, 14, 8);

      // face
      ctx.fillStyle = '#f1d2b0'; ctx.beginPath(); ctx.ellipse(p.x+p.w/2, p.y+10, 12, 12, 0, 0, Math.PI*2); ctx.fill();

      // spiky hair (stylized, original) - red when transformed
      ctx.fillStyle = (ultraMode ? '#c0c0c0' : (godMode ? '#e63946' : '#0b0b0b')); 
      ctx.beginPath();
      ctx.moveTo(p.x + p.w/2, p.y - 8);
      ctx.lineTo(p.x + p.w - 2, p.y + 6);
      ctx.lineTo(p.x + p.w/2 + 6, p.y + 2);
      ctx.lineTo(p.x + p.w/2 + 2, p.y + 12);
      ctx.lineTo(p.x + p.w/2 - 6, p.y + 4);
      ctx.lineTo(p.x + 2, p.y + 8);
      ctx.closePath(); ctx.fill();
      
      // god/ultra mode aura
      if(godMode || ultraMode){
        ctx.globalAlpha = 0.15;
        ctx.fillStyle = ultraMode ? '#e0e0e0' : '#ff4757';
        ctx.beginPath();
        ctx.ellipse(p.x + p.w/2, p.y + 5, 20, 18, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      // eyes (simple line brows)
      ctx.fillStyle = '#111'; ctx.fillRect(p.x + p.w*0.32, p.y + 8, p.w*0.08, 2); ctx.fillRect(p.x + p.w*0.56, p.y + 8, p.w*0.08, 2);

      ctx.restore();
    }

    // Draw enemy (Frieza-inspired alien - original art)
    function drawEnemy(e){
      ctx.save();
      
      // tail (curved, white with purple tip)
      ctx.strokeStyle = '#c0c0c0'; ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(e.x + e.w/2, e.y + e.h - 10);
      ctx.quadraticCurveTo(e.x + e.w + 25, e.y + e.h/2, e.x + e.w - 8, e.y + e.h*0.3);
      ctx.stroke();
      // purple tail tip
      ctx.strokeStyle = '#8b3a9a'; ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(e.x + e.w - 8, e.y + e.h*0.3);
      ctx.quadraticCurveTo(e.x + e.w + 18, e.y + e.h*0.2, e.x + e.w + 12, e.y + e.h*0.1);
      ctx.stroke();
      
      // white body (torso)
      ctx.fillStyle = '#e8e8e8';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.5, e.w*0.46, e.h*0.52, 0, 0, Math.PI*2);
      ctx.fill();
      
      // purple chest armor (diamond shaped)
      ctx.fillStyle = '#7a3e99';
      ctx.beginPath();
      ctx.moveTo(e.x + e.w/2, e.y + e.h*0.35);
      ctx.lineTo(e.x + e.w*0.7, e.y + e.h*0.55);
      ctx.lineTo(e.x + e.w/2, e.y + e.h*0.68);
      ctx.lineTo(e.x + e.w*0.3, e.y + e.h*0.55);
      ctx.closePath();
      ctx.fill();
      
      // purple shoulder pauldrons
      ctx.fillStyle = '#6a2d99';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.15, e.y + e.h*0.46, e.w*0.16, e.h*0.2, -0.4, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.85, e.y + e.h*0.46, e.w*0.16, e.h*0.2, 0.4, 0, Math.PI*2);
      ctx.fill();
      
      // white gloved hands
      ctx.fillStyle = '#f5f5f5';
      ctx.beginPath();
      ctx.ellipse(e.x - 8, e.y + e.h*0.48, 7, 10, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w + 8, e.y + e.h*0.48, 7, 10, 0, 0, Math.PI*2);
      ctx.fill();
      
      // purple leg armor
      ctx.fillStyle = '#8b3a9a';
      ctx.fillRect(e.x + e.w*0.22, e.y + e.h*0.68, e.w*0.28, e.h*0.28);
      ctx.fillRect(e.x + e.w*0.5, e.y + e.h*0.68, e.w*0.28, e.h*0.28);
      
      // white under-legs
      ctx.fillStyle = '#e8e8e8';
      ctx.fillRect(e.x + e.w*0.22, e.y + e.h*0.8, e.w*0.28, e.h*0.2);
      ctx.fillRect(e.x + e.w*0.5, e.y + e.h*0.8, e.w*0.28, e.h*0.2);
      
      // distinctive head (dome-shaped purple)
      ctx.fillStyle = '#6a2d99';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.24, e.w*0.32, e.h*0.24, 0, 0, Math.PI*2);
      ctx.fill();
      
      // head highlight (dome shine)
      ctx.fillStyle = '#9b5bb8';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2 - 4, e.y + e.h*0.14, e.w*0.15, e.h*0.12, 0, 0, Math.PI*2);
      ctx.fill();
      
      // large purple eyes
      ctx.fillStyle = '#4a1a7a';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.36, e.y + e.h*0.2, e.w*0.09, e.h*0.08, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.64, e.y + e.h*0.2, e.w*0.09, e.h*0.08, 0, 0, Math.PI*2);
      ctx.fill();
      
      // eye shine
      ctx.fillStyle = '#000';
      ctx.fillRect(e.x + e.w*0.35, e.y + e.h*0.18, e.w*0.035, e.h*0.05);
      ctx.fillRect(e.x + e.w*0.63, e.y + e.h*0.18, e.w*0.035, e.h*0.05);
      
      ctx.restore();
    }

    // Draw strong enemy (Cell-inspired insectoid — original art)
    function drawStrongEnemy(e){
      ctx.save();
      
      // legs/lower body (green with spots)
      ctx.fillStyle = '#5dbd4e';
      ctx.fillRect(e.x + e.w*0.2, e.y + e.h*0.64, e.w*0.28, e.h*0.36);
      ctx.fillRect(e.x + e.w*0.52, e.y + e.h*0.64, e.w*0.28, e.h*0.36);
      // yellow boots/feet
      ctx.fillStyle = '#ffd700';
      ctx.fillRect(e.x + e.w*0.2, e.y + e.h*0.92, e.w*0.28, e.h*0.08);
      ctx.fillRect(e.x + e.w*0.52, e.y + e.h*0.92, e.w*0.28, e.h*0.08);
      
      // torso/body (spotted green)
      ctx.fillStyle = '#5dbd4e';
      ctx.beginPath(); 
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.5, e.w*0.46, e.h*0.42, 0, 0, Math.PI*2); 
      ctx.fill();
      
      // spots on body (darker green/black)
      ctx.fillStyle = '#1a4d2e';
      for(let i=0; i<8; i++){
        const spotX = e.x + e.w*(0.2 + Math.sin(i*1.3)*0.15 + 0.3);
        const spotY = e.y + e.h*(0.4 + Math.cos(i*1.7)*0.2 + 0.2);
        ctx.beginPath();
        ctx.arc(spotX, spotY, e.w*0.06 + (i%2)*2, 0, Math.PI*2);
        ctx.fill();
      }
      
      // white chest armor plates
      ctx.fillStyle = '#e8e8e8';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.46, e.w*0.32, e.h*0.28, 0, 0, Math.PI*2);
      ctx.fill();
      // armor detail lines
      ctx.strokeStyle = '#b0b0b0';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(e.x + e.w*0.32, e.y + e.h*0.38);
      ctx.lineTo(e.x + e.w*0.68, e.y + e.h*0.38);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.x + e.w*0.5, e.y + e.h*0.3);
      ctx.lineTo(e.x + e.w*0.5, e.y + e.h*0.62);
      ctx.stroke();
      
      // purple/dark shoulder plates
      ctx.fillStyle = '#5a2d7a';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.15, e.y + e.h*0.42, e.w*0.18, e.h*0.16, -0.3, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.85, e.y + e.h*0.42, e.w*0.18, e.h*0.16, 0.3, 0, Math.PI*2);
      ctx.fill();
      
      // arms (green spotted)
      ctx.fillStyle = '#5dbd4e';
      ctx.fillRect(e.x - 6, e.y + e.h*0.4, 12, 24);
      ctx.fillRect(e.x + e.w - 6, e.y + e.h*0.4, 12, 24);
      // spots on arms
      ctx.fillStyle = '#1a4d2e';
      ctx.beginPath(); ctx.arc(e.x - 2, e.y + e.h*0.48, 3, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(e.x + e.w + 2, e.y + e.h*0.48, 3, 0, Math.PI*2); ctx.fill();
      
      // black helmet/head crest (angular insectoid)
      ctx.fillStyle = '#1a1a2e';
      ctx.beginPath();
      ctx.moveTo(e.x + e.w*0.5, e.y - e.h*0.08);
      ctx.lineTo(e.x + e.w*0.25, e.y + e.h*0.18);
      ctx.lineTo(e.x + e.w*0.3, e.y + e.h*0.28);
      ctx.lineTo(e.x + e.w*0.7, e.y + e.h*0.28);
      ctx.lineTo(e.x + e.w*0.75, e.y + e.h*0.18);
      ctx.closePath();
      ctx.fill();
      
      // purple head accent
      ctx.fillStyle = '#6a3d8a';
      ctx.fillRect(e.x + e.w*0.35, e.y + e.h*0.14, e.w*0.3, e.h*0.08);
      
      // eyes (pink/red glowing)
      ctx.fillStyle = '#ff1744';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.38, e.y + e.h*0.22, e.w*0.08, e.h*0.05, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.62, e.y + e.h*0.22, e.w*0.08, e.h*0.05, 0, 0, Math.PI*2);
      ctx.fill();
      
      // energy aura when strong
      if(e.hp > 1){ 
        ctx.globalAlpha = 0.10; 
        ctx.fillStyle = '#7bed9f'; 
        ctx.beginPath(); 
        ctx.ellipse(e.x + e.w/2, e.y + e.h/2, e.w*0.9, e.h, 0, 0, Math.PI*2); 
        ctx.fill(); 
      }
      ctx.restore();
    }

    // Draw boss enemy (Beerus-inspired original cat-deity look — original art)
    function drawBoss(e){
      ctx.save();
      
      // lower robes / pants (orange and gold flowing)
      ctx.fillStyle = '#ff8533'; 
      ctx.fillRect(e.x + e.w*0.15, e.y + e.h*0.52, e.w*0.7, e.h*0.48);
      // gold trim on pants
      ctx.fillStyle = '#d4af37'; 
      ctx.fillRect(e.x + e.w*0.15, e.y + e.h*0.52, e.w*0.7, e.h*0.06);
      
      // blue sash / waist wrap
      ctx.fillStyle = '#1e5ba8';
      ctx.fillRect(e.x + e.w*0.12, e.y + e.h*0.44, e.w*0.76, e.h*0.14);
      // sash detail
      ctx.fillStyle = '#2b6bff';
      ctx.fillRect(e.x + e.w*0.14, e.y + e.h*0.46, e.w*0.72, e.h*0.04);
      
      // upper body (purple skin)
      ctx.fillStyle = '#9370db';
      ctx.beginPath(); ctx.ellipse(e.x + e.w/2, e.y + e.h*0.32, e.w*0.42, e.h*0.28, 0, 0, Math.PI*2); ctx.fill();
      
      // ornate collar / chest piece (gold)
      ctx.fillStyle = '#d4af37';
      ctx.beginPath();
      ctx.arc(e.x + e.w/2, e.y + e.h*0.38, e.w*0.48, Math.PI * 1.1, Math.PI * 1.9);
      ctx.arc(e.x + e.w/2, e.y + e.h*0.38, e.w*0.35, Math.PI * 1.9, Math.PI * 1.1, true);
      ctx.closePath();
      ctx.fill();
      
      // collar details (darker gold accents)
      ctx.fillStyle = '#b8860b';
      ctx.fillRect(e.x + e.w*0.22, e.y + e.h*0.36, e.w*0.08, e.h*0.04);
      ctx.fillRect(e.x + e.w*0.7, e.y + e.h*0.36, e.w*0.08, e.h*0.04);
      
      // neck/shoulders purple
      ctx.fillStyle = '#9370db';
      ctx.fillRect(e.x + e.w*0.4, e.y + e.h*0.28, e.w*0.2, e.h*0.12);
      
      // long cat-like ears (purple, tall and pointed)
      ctx.fillStyle = '#7a5bb5';
      ctx.beginPath();
      ctx.moveTo(e.x + e.w*0.25, e.y + e.h*0.18);
      ctx.lineTo(e.x + e.w*0.15, e.y - e.h*0.25);
      ctx.lineTo(e.x + e.w*0.35, e.y + e.h*0.15);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(e.x + e.w*0.75, e.y + e.h*0.18);
      ctx.lineTo(e.x + e.w*0.85, e.y - e.h*0.25);
      ctx.lineTo(e.x + e.w*0.65, e.y + e.h*0.15);
      ctx.closePath();
      ctx.fill();
      
      // head (purple)
      ctx.fillStyle = '#9370db';
      ctx.beginPath(); 
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.2, e.w*0.28, e.h*0.18, 0, 0, Math.PI*2); 
      ctx.fill();
      
      // eyes (cat-like, slanted)
      ctx.fillStyle = '#ffd700';
      ctx.beginPath(); 
      ctx.ellipse(e.x + e.w*0.38, e.y + e.h*0.2, e.w*0.08, e.h*0.05, 0, 0, Math.PI*2); 
      ctx.fill();
      ctx.beginPath(); 
      ctx.ellipse(e.x + e.w*0.62, e.y + e.h*0.2, e.w*0.08, e.h*0.05, 0, 0, Math.PI*2); 
      ctx.fill();
      // pupils (vertical slits)
      ctx.fillStyle = '#111';
      ctx.fillRect(e.x + e.w*0.37, e.y + e.h*0.19, e.w*0.02, e.h*0.045);
      ctx.fillRect(e.x + e.w*0.61, e.y + e.h*0.19, e.w*0.02, e.h*0.045);
      
      // arms (purple)
      ctx.fillStyle = '#9370db'; 
      ctx.fillRect(e.x - 8, e.y + e.h*0.36, 14, 22); 
      ctx.fillRect(e.x + e.w - 6, e.y + e.h*0.36, 14, 22);
      
      // staff/scepter hint (if space permits - simple circle on stick)
      ctx.strokeStyle = '#d4af37'; 
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(e.x + e.w + 8, e.y + e.h*0.5);
      ctx.lineTo(e.x + e.w + 8, e.y + e.h*0.15);
      ctx.stroke();
      ctx.fillStyle = '#d4af37';
      ctx.beginPath();
      ctx.arc(e.x + e.w + 8, e.y + e.h*0.1, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = 'transparent';
      ctx.strokeStyle = '#d4af37';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(e.x + e.w + 8, e.y + e.h*0.1, 4, 0, Math.PI*2);
      ctx.stroke();
      
      // power aura when damaged
      if(e.hp < (variantHp(e))) { 
        ctx.globalAlpha = 0.12; 
        ctx.fillStyle = '#ba55d3'; 
        ctx.beginPath(); 
        ctx.ellipse(e.x + e.w/2, e.y + e.h/2, e.w*1.2, e.h*1.2, 0, 0, Math.PI*2); 
        ctx.fill(); 
      }
      ctx.restore();
    }

    // Draw Jiren enemy
    function drawJiren(e){
      ctx.save();
      
      // white gloved hands
      ctx.fillStyle = '#e8e8e8';
      ctx.beginPath();
      ctx.ellipse(e.x - 10, e.y + e.h*0.48, 8, 12, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w + 10, e.y + e.h*0.48, 8, 12, 0, 0, Math.PI*2);
      ctx.fill();
      
      // dark grey pants/legs
      ctx.fillStyle = '#3a3a3a';
      ctx.fillRect(e.x + e.w*0.18, e.y + e.h*0.6, e.w*0.3, e.h*0.4);
      ctx.fillRect(e.x + e.w*0.52, e.y + e.h*0.6, e.w*0.3, e.h*0.4);
      
      // white feet/boots
      ctx.fillStyle = '#e8e8e8';
      ctx.fillRect(e.x + e.w*0.18, e.y + e.h*0.92, e.w*0.3, e.h*0.08);
      ctx.fillRect(e.x + e.w*0.52, e.y + e.h*0.92, e.w*0.3, e.h*0.08);
      
      // dark grey/black body
      ctx.fillStyle = '#4a4a4a';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.5, e.w*0.46, e.h*0.45, 0, 0, Math.PI*2);
      ctx.fill();
      
      // red and black chest armor (angular, V-shaped)
      ctx.fillStyle = '#d63031';
      ctx.beginPath();
      ctx.moveTo(e.x + e.w/2, e.y + e.h*0.32);
      ctx.lineTo(e.x + e.w*0.75, e.y + e.h*0.55);
      ctx.lineTo(e.x + e.w/2, e.y + e.h*0.58);
      ctx.lineTo(e.x + e.w*0.25, e.y + e.h*0.55);
      ctx.closePath();
      ctx.fill();
      
      // black chest stripe down the middle
      ctx.fillStyle = '#2d2d2d';
      ctx.fillRect(e.x + e.w*0.48, e.y + e.h*0.32, e.w*0.04, e.h*0.26);
      
      // red shoulder armor
      ctx.fillStyle = '#d63031';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.12, e.y + e.h*0.42, e.w*0.15, e.h*0.18, -0.35, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.88, e.y + e.h*0.42, e.w*0.15, e.h*0.18, 0.35, 0, Math.PI*2);
      ctx.fill();
      
      // black upper arm bands
      ctx.fillStyle = '#2d2d2d';
      ctx.fillRect(e.x - 12, e.y + e.h*0.38, 10, 16);
      ctx.fillRect(e.x + e.w + 2, e.y + e.h*0.38, 10, 16);
      
      // grey/white head
      ctx.fillStyle = '#c0c0c0';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2, e.y + e.h*0.22, e.w*0.32, e.h*0.22, 0, 0, Math.PI*2);
      ctx.fill();
      
      // bald appearance with shine
      ctx.fillStyle = '#e0e0e0';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w/2 - 3, e.y + e.h*0.12, e.w*0.18, e.h*0.14, 0, 0, Math.PI*2);
      ctx.fill();
      
      // dark intense eyes
      ctx.fillStyle = '#1a1a1a';
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.38, e.y + e.h*0.21, e.w*0.09, e.h*0.07, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.beginPath();
      ctx.ellipse(e.x + e.w*0.62, e.y + e.h*0.21, e.w*0.09, e.h*0.07, 0, 0, Math.PI*2);
      ctx.fill();
      
      // eye whites
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(e.x + e.w*0.37, e.y + e.h*0.2, e.w*0.035, e.h*0.05);
      ctx.fillRect(e.x + e.w*0.625, e.y + e.h*0.2, e.w*0.035, e.h*0.05);
      
      // powerful aura when at higher HP
      if(e.hp > 5){
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = '#ff6b6b';
        ctx.beginPath();
        ctx.ellipse(e.x + e.w/2, e.y + e.h/2, e.w*1.15, e.h*1.15, 0, 0, Math.PI*2);
        ctx.fill();
      }
      
      ctx.restore();
    }

    function variantHp(e){ return e.variant === 'jiren' ? 5 : (e.variant === 'boss' ? 5 : (e.variant === 'strong' ? 3 : 1)); }

    // Draw pickup
    function drawPickup(p){
      // Dragon ball coin
      const cx = p.x + p.w/2;
      const cy = p.y + p.h/2;
      const r = p.w/2;
      ctx.fillStyle = '#ffb347';
      ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill();
      // shine
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.beginPath(); ctx.ellipse(cx - r*0.25, cy - r*0.25, r*0.35, r*0.22, -0.4, 0, Math.PI*2); ctx.fill();
      // star
      ctx.fillStyle = '#d61f1f';
      ctx.beginPath();
      ctx.moveTo(cx, cy - r*0.45);
      ctx.lineTo(cx + r*0.14, cy - r*0.05);
      ctx.lineTo(cx + r*0.45, cy - r*0.05);
      ctx.lineTo(cx + r*0.2, cy + r*0.1);
      ctx.lineTo(cx + r*0.3, cy + r*0.45);
      ctx.lineTo(cx, cy + r*0.2);
      ctx.lineTo(cx - r*0.3, cy + r*0.45);
      ctx.lineTo(cx - r*0.2, cy + r*0.1);
      ctx.lineTo(cx - r*0.45, cy - r*0.05);
      ctx.lineTo(cx - r*0.14, cy - r*0.05);
      ctx.closePath(); ctx.fill();
    }

    // Update loop
    let spawnTimer = 0;
    let cycleTimer = 0; // ms counter for flight windows (30s cycle)
    let flashTimer = 0; // ms, visual flash when board-clear used
    // damage per second when in contact with enemy
    const contactDPS = 20; // HP per second
    function update(dt){
      if(winGame){
        return;
      }
      // H A C K 1 cheat code (takes priority): unlock Ultra Mode instantly
      if(keys['h'] && keys['a'] && keys['c'] && keys['k'] && keys['1']){
        if(!hackOneCheatUsed){
          ultraMode = true;
          godMode = true;
          ultraModeTriggered = true;
          score += 10000;
          player.hp = 100;
          hackOneCheatUsed = true;
          tone(1400, 0.3, 'sine', 0.2);
          tone(1600, 0.3, 'sine', 0.2);
          tone(1800, 0.3, 'sine', 0.2);
        }
      } else if(!(keys['h'] && keys['a'] && keys['c'] && keys['k'] && keys['1'])){
        hackOneCheatUsed = false;
      }
      
      // HACK cheat code: H + A + C + K = 50 kills
      if(keys['h'] && keys['a'] && keys['c'] && keys['k'] && !keys['1']){
        if(!hackCheatUsed){
          addKills(50);
          score += 5000;
          hackCheatUsed = true;
          tone(1200, 0.3, 'sine', 0.2);
          tone(1400, 0.3, 'sine', 0.2);
        }
      } else if(!(keys['h'] && keys['a'] && keys['c'] && keys['k'])){
        hackCheatUsed = false;
      }

      // FLY cheat code: F + L + Y = infinite fly time
      if(keys['f'] && keys['l'] && keys['y']){
        if(!flyCheatUsed){
          infiniteFly = true;
          player.flyTime = player.flyTimeMax;
          flyCheatUsed = true;
          tone(980, 0.2, 'sine', 0.16);
        }
      } else if(!(keys['f'] && keys['l'] && keys['y'])){
        flyCheatUsed = false;
      }

      if(jirenSummonCooldown > 0){
        jirenSummonCooldown = Math.max(0, jirenSummonCooldown - dt);
      }

      // Jiren summon: press J when unlocked
      if(jirenUnlocked && keys['j'] && jirenSummonCooldown <= 0){
        entities.push({type:'ally', variant:'jiren', x: player.x + 60, y: player.y, w:48, h:56, vx:0, created: Date.now(), lifespan: 8000, lastHit: 0});
        jirenSummonCooldown = 12000;
        tone(760, 0.2, 'sine', 0.18);
      }

      // retry mini games with START (Enter)
      if(retryPending && keys['enter']){
        if(retryPending === 'god'){
          startGodMiniGame();
        } else if(retryPending === 'ultra'){
          startUltraMiniGame();
        }
      }
      
      // player input
      const left = keys['arrowleft'];
      const right = keys['arrowright'];
      const up = keys['arrowup'];
      const attack = keys['z'];
      const blast = keys['x'];

      if(left) { player.vx = Math.max(player.vx - 0.6, -4); player.facing = -1; }
      if(right){ player.vx = Math.min(player.vx + 0.6, 4); player.facing = 1; }
      if(!left && !right) player.vx *= friction;

      // (input listeners handled at top-level)

      // energy blast charging
      if(blast){ player.charging = true; player.energy = Math.min(100, player.energy + 0.9); }
      else if(player.charging){
        // release blast
        const power = Math.max(8, 6 + Math.floor(player.energy/20));
        // if player has enough coins, fire a super blast (piercing)
        if(coinCount >= 10){
          const superProj = {type:'super', x:player.x + player.w/2 + (player.facing>0?28:-28), y:player.y+22, w:28, h:16, vx: player.facing * (6 + power*0.6), power, hitsRemaining: 6, lifespan: 3500, created: Date.now()};
          entities.push(superProj);
          coinCount = 0; // consume coins
          tone(320, 0.4, 'sawtooth', 0.16);
        } else {
          // regular projectile (single-kill)
          const proj = {type:'proj', x:player.x + player.w/2 + (player.facing>0?20:-20), y:player.y+24, w:12, h:8, vx: player.facing * (6 + power*0.6), power};
          entities.push(proj);
          tone(180 + power*30, 0.12, 'sawtooth', 0.12);
        }
        player.charging = false; player.energy = 0;
      }

      // physics
      player.vy += gravity;
      player.x += player.vx; player.y += player.vy;
      // clamp player to a lower airborne band instead of hard ground snap
      const lowerBand = H * 0.6;
      if(player.y + player.h >= lowerBand){ player.y = lowerBand - player.h; player.vy = 0; player.onGround = true; }
      if(player.x < 10) player.x = 10; if(player.x + player.w > W-10) player.x = W-10-player.w;

      // update visual clouds
      for(let c of clouds){ c.x += c.vx * dt * 0.06; if(c.x - c.w > W) c.x = -c.w - rand(20,80); }

      // update entities
      for(let i = entities.length-1; i>=0; i--){ const e = entities[i];
        if(e.type==='ally'){
          // follow the player loosely
          const targetX = player.x + (player.facing > 0 ? 60 : -60);
          const targetY = player.y - 6;
          e.x += (targetX - e.x) * 0.08;
          e.y += (targetY - e.y) * 0.08;

          // damage enemies on contact with a short cooldown
          for(let j = entities.length-1; j>=0; j--){ const t = entities[j];
            if(t.type === 'enemy' && collide(e,t)){
              const now = Date.now();
              if(now - (e.lastHit || 0) > 280){
                t.hp = (typeof t.hp === 'number') ? t.hp : 1;
                t.hp -= 1;
                e.lastHit = now;
                tone(520,0.05,'triangle',0.08);
                if(t.hp <= 0){
                  if(inMiniGame && t.variant === 'boss'){
                    miniGameBossesKilled += 1;
                  }
                  if(inUltraMiniGame && t.variant === 'jiren'){
                    ultraGameJirenKilled = true;
                    jirenUnlocked = true;
                  }
                  if(t.variant === 'boss' && !inMiniGame){
                    for(let c=0;c<3;c++) spawnPickup(t.x + t.w/2 + (c-1)*10, t.y + t.h/2 + (c%2? -6:4));
                  }
                  if(t.variant === 'jiren' && !inUltraMiniGame){
                    for(let c=0;c<7;c++) spawnPickup(t.x + t.w/2 + (c-3)*8, t.y + t.h/2 + (c%2? -6:4));
                  }
                  score += (t.variant === 'strong') ? 180 : (t.variant === 'boss' ? 300 : 35);
                  if(!inMiniGame && !inUltraMiniGame) addKills(1);
                  entities.splice(j,1);
                }
              }
            }
          }

          if(Date.now() - e.created > (e.lifespan || 8000)){
            entities.splice(i,1);
          }
          continue;
        }
        if(e.type==='enemy'){
          e.x += e.vx;
          // if enemy touches player, drain health over time
          if(collide(player, e)){
            player.hp = Math.max(0, player.hp - (contactDPS * (dt/1000)));
            // small knockback to avoid instant trapping
            player.vx = -e.vx * 0.6;
            tone(220, 0.04, 'sine', 0.06);
          }
          if(Math.abs(e.x - player.x) < 10 && Math.random() < 0.004){ /* occasional random move */ }
          // strong, boss, and jiren types stay on-screen and bounce at edges
          if(e.variant === 'strong' || e.variant === 'boss' || e.variant === 'jiren'){
            if(e.x < 20){ e.x = 20; e.vx = Math.abs(e.vx); }
            if(e.x + e.w > W - 20){ e.x = W - 20 - e.w; e.vx = -Math.abs(e.vx); }
          } else {
            if(e.x < -100 || e.x > W+100) entities.splice(i,1);
          }
        }
        if(e.type==='proj'){
          e.x += e.vx; // hit enemies
          for(let j=entities.length-1;j>=0;j--){ const t=entities[j]; if(t.type==='enemy' && collide(e,t)){
              // projectile damage based on god/ultra mode
              t.hp = (typeof t.hp === 'number') ? t.hp : 1;
              if(t.variant === 'jiren' && inUltraMiniGame && !ultraMode){
                t.hp -= 1; // requires 10 blasts in the Jiren mini game
              } else if(ultraMode){
                // Ultra Mode: instant kill normal/strong, 5 damage to boss/jiren
                if(t.variant === 'normal' || t.variant === 'strong'){
                  t.hp = 0; // instant kill
                } else {
                  t.hp -= 5; // 5 damage to bosses and jiren
                }
              } else if(godMode){
                // God Mode: kills normal enemies instantly, 2 damage to strong/boss
                if(t.variant === 'normal'){
                  t.hp = 0; // instant kill
                } else {
                  t.hp -= 2; // 2 damage to strong and boss
                }
              } else {
                t.hp -= 1; // normal damage
              }
              // hit feedback
              tone(440,0.06,'triangle',0.12);
              if(t.hp <= 0){
                // Track mini game boss kills
                if(inMiniGame && t.variant === 'boss'){
                  miniGameBossesKilled += 1;
                }
                if(inUltraMiniGame && t.variant === 'jiren'){
                  ultraGameJirenKilled = true;
                  jirenUnlocked = true;
                }
                // Only bosses drop coins — spawn 3 guaranteed coins at boss death
                if(t.variant === 'boss' && !inMiniGame){
                  for(let c=0;c<3;c++) spawnPickup(t.x + t.w/2 + (c-1)*10, t.y + t.h/2 + (c%2? -6:4));
                }
                if(t.variant === 'jiren' && !inUltraMiniGame){
                  for(let c=0;c<7;c++) spawnPickup(t.x + t.w/2 + (c-3)*8, t.y + t.h/2 + (c%2? -6:4));
                }
                if(t.variant === 'jiren' && !inUltraMiniGame){
                  for(let c=0;c<7;c++) spawnPickup(t.x + t.w/2 + (c-3)*8, t.y + t.h/2 + (c%2? -6:4));
                }
                // scoring: stronger enemies give more
                score += (t.variant === 'strong') ? 180 : (t.variant === 'boss' ? 300 : 35);
                if(!inMiniGame && !inUltraMiniGame) addKills(1);
                entities.splice(j,1);
              }
              // remove projectile after hit
              entities.splice(i,1);
              break;
            } }
          if(e.x < -50 || e.x > W+50) entities.splice(i,1);
        }
        if(e.type==='super'){
          // piercing projectile: moves, damages multiple enemies until hitsRemaining or lifespan expires
          e.x += e.vx;
          for(let j=entities.length-1;j>=0;j--){ const t = entities[j]; if(t.type==='enemy' && collide(e,t)){
              // super damage based on god/ultra mode
              t.hp = (typeof t.hp === 'number') ? t.hp : 1;
              if(t.variant === 'jiren' && inUltraMiniGame && !ultraMode){
                t.hp -= 1; // requires 10 blasts in the Jiren mini game
              } else if(ultraMode){
                // Ultra Mode super: instant kill normal/strong, 5 damage to bosses/jiren
                if(t.variant === 'normal' || t.variant === 'strong'){
                  t.hp = 0;
                } else {
                  t.hp -= 5;
                }
              } else if(godMode){
                // God Mode super: instant kill normal, 5 damage to strong/boss
                if(t.variant === 'normal'){
                  t.hp = 0;
                } else {
                  t.hp -= 5;
                }
              } else {
                t.hp -= 3; // normal super damage
              }
              tone(720,0.06,'triangle',0.14);
              if(t.hp <= 0){
                // Track mini game boss kills
                if(inMiniGame && t.variant === 'boss'){
                  miniGameBossesKilled += 1;
                }
                if(inUltraMiniGame && t.variant === 'jiren'){
                  ultraGameJirenKilled = true;
                  jirenUnlocked = true;
                }
                // Only bosses drop coins — spawn 3 guaranteed coins at boss death
                if(t.variant === 'boss' && !inMiniGame){
                  for(let c=0;c<3;c++) spawnPickup(t.x + t.w/2 + (c-1)*10, t.y + t.h/2 + (c%2? -6:4));
                }
                score += (t.variant === 'strong') ? 220 : (t.variant === 'boss' ? 500 : 60);
                if(!inMiniGame && !inUltraMiniGame) addKills(1);
                entities.splice(j,1);
              }
              e.hitsRemaining = (typeof e.hitsRemaining === 'number') ? e.hitsRemaining - 1 : 0;
            }
          }
          if((e.hitsRemaining !== undefined && e.hitsRemaining <= 0) || (Date.now() - e.created > (e.lifespan || 3500))){ entities.splice(i,1); }
        }
        if(e.type==='pickup'){
          if(collide(player,e)){
            // coin pickup
            if(e.kind === 'coin'){
              coinCount += (e.value || 1);
              score += (e.value || 1) * 5;
              tone(880,0.08,'sine',0.08);
              entities.splice(i,1);
            } else {
              score += e.value; entities.splice(i,1); tone(880,0.08,'sine',0.08);
            }
          }
        }
      }

      // God mini game trigger at 50 kills
      if(!miniGameTriggered && killCount >= 50 && !inMiniGame && !retryPending){
        startGodMiniGame();
      }

      // Check god mini game completion
      if(inMiniGame && miniGameBossesKilled >= 5){
        inMiniGame = false;
        godMode = true;
        player.hp = 100;
        tone(880, 0.8, 'sine', 0.2);
        tone(1100, 0.8, 'sine', 0.2);
      }

      // Ultra Mode trigger at 100 kills (only if God Mode unlocked)
      ultraReady = (killCount >= 100 && godMode && !inUltraMiniGame && !retryPending && !ultraMode);
      if(ultraReady && !ultraModeTriggered){
        startUltraMiniGame();
      }
      // manual Jiren spawn (press U) outside mini games
      if(keys['u'] && !inUltraMiniGame && !inMiniGame && !retryPending){
        if(!jirenSpawnUsed){
          const hasJiren = entities.some(ent => ent.type === 'enemy' && ent.variant === 'jiren');
          if(!hasJiren){
            entities.push({type:'enemy', variant:'jiren', x: W/2, y: H*0.4, w:48, h:56, vx: 0.5, hp:5});
            tone(640, 0.2, 'sine', 0.16);
          }
          jirenSpawnUsed = true;
        }
      } else if(!keys['u']){
        jirenSpawnUsed = false;
      }
      
      // Check ultra mode mini game completion
      if(inUltraMiniGame && ultraGameJirenKilled){
        inUltraMiniGame = false;
        ultraMode = true;
        godMode = true; // keep god powers too
        player.hp = 100;
        tone(880, 0.8, 'sine', 0.2);
        tone(1100, 0.8, 'sine', 0.2);
        tone(1320, 0.8, 'sine', 0.2);
      }

      if(!formsUnlocked && godMode && ultraMode){
        formsUnlocked = true;
        setForm('ultra');
      }

      // Win condition: all forms + 500 kills
      if(!winGame && godMode && ultraMode && killCount >= 500){
        winGame = true;
        entities = [];
        tone(520, 0.6, 'sine', 0.2);
        tone(780, 0.6, 'sine', 0.2);
      }
      
      // spawn logic (reduced spawn frequency) - disabled during mini games
      if(!inMiniGame && !inUltraMiniGame){
        spawnTimer += dt;
        if(spawnTimer > 3000){ spawnEnemy(); spawnTimer = 0; }
      }

      // flight cycle: grant up to flyTimeMax every 30 seconds
      cycleTimer += dt;
      if(cycleTimer >= 30000){
        cycleTimer -= 30000;
        player.flyTime = player.flyTimeMax;
      }

      if(infiniteFly){
        player.flyTime = player.flyTimeMax;
      }

      // flying: hold up to ascend while you have flyTime remaining
      const upHeld = keys['arrowup'];
      if(upHeld && player.flyTime > 0){
        // provide lift
        player.vy = Math.max(player.vy - 0.9, -6);
        if(!infiniteFly){
          player.flyTime = Math.max(0, player.flyTime - dt);
        }
      }
      // no recharge: fly time depletes until exhausted

      // update flash timer
      if(flashTimer > 0) flashTimer = Math.max(0, flashTimer - dt);

      // update HUD
      document.getElementById('score').textContent = 'Score: ' + score;
      document.getElementById('lives').textContent = 'Lives: ' + lives;
      document.getElementById('health').textContent = 'Health: ' + Math.max(0, Math.round(player.hp)) + '%';
      document.getElementById('kills').textContent = 'Kills: ' + killCount + (killCount >= 50 || miniGameTriggered ? '' : '/50');
      document.getElementById('coins').textContent = 'Coins: ' + coinCount;
      document.getElementById('super').textContent = 'Super: ' + superStock;
      document.getElementById('energy').textContent = 'Energy: ' + Math.round(player.energy) + '%';
      // cycle HUD: remaining time until cycle reset and remaining fly time
      const remainingCycle = Math.max(0, (30000 - cycleTimer) / 1000);
      const flySecs = Math.max(0, player.flyTime / 1000).toFixed(1);
      document.getElementById('cycle').textContent = 'Cycle: ' + remainingCycle.toFixed(1) + 's | Fly: ' + flySecs + 's';

      if(formsUnlocked){
        formControls.classList.remove('hidden');
      }

      // handle death / life loss
      if(player.hp <= 0){
        // Ultra mini game failure
        if(inUltraMiniGame){
          inUltraMiniGame = false;
          ultraGameJirenKilled = false;
          player.hp = 100;
          entities = [];
          retryPending = 'ultra';
          tone(120, 0.5, 'sawtooth', 0.2);
        }
        // Mini game failure
        else if(inMiniGame){
          inMiniGame = false;
          miniGameBossesKilled = 0;
          player.hp = 100;
          entities = [];
          retryPending = 'god';
          tone(120, 0.5, 'sawtooth', 0.2);
        } else {
          lives = Math.max(0, lives - 1);
          tone(120,0.28,'sawtooth',0.16);
          // respawn or game over
          if(lives > 0){
            player.hp = 100; player.x = 120; player.y = H-120; entities = []; // clear threats
          } else {
            // game over - reset everything after brief pause
            player.hp = 100; score = 0; lives = 3; entities = []; player.x = 120; player.y = H-120;
            godMode = false; miniGameTriggered = false; ultraMode = false; ultraModeTriggered = false;
          }
        }
      }
    }

    function render(){
      if(winGame){
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,W,H);
        if(winImage.complete){
          const aspect = winImage.width / winImage.height;
          const targetW = Math.min(W * 0.9, H * aspect * 0.9);
          const targetH = targetW / aspect;
          const dx = (W - targetW) / 2;
          const dy = (H - targetH) / 2;
          ctx.drawImage(winImage, dx, dy, targetW, targetH);
        }
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.fillRect(0, 0, W, H);
        ctx.fillStyle = '#ffd700';
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('YOU WIN!', W/2, H/2 + 12);
        ctx.textAlign = 'left';
        return;
      }
      // sky background gradient
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0,'#87ceeb'); g.addColorStop(1,'#bfe9ff');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

      // clouds
      for(let c of clouds){ ctx.save(); ctx.fillStyle = 'rgba(255,255,255,0.92)'; ctx.beginPath(); ctx.ellipse(c.x, c.y, c.w*0.6, c.w*0.32, 0, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.ellipse(c.x + c.w*0.28, c.y + 6, c.w*0.48, c.w*0.28, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); }

      // grassy ground
      ctx.fillStyle = '#2ea84a'; ctx.fillRect(0, LOWER_BAND, W, H - LOWER_BAND);
      // draw a few rocky boulders
      for(let b of boulders){ ctx.save(); ctx.fillStyle = '#6b6b6b'; ctx.beginPath(); ctx.ellipse(b.x, b.y, b.r*1.2, b.r, 0, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = '#4f4f4f'; ctx.beginPath(); ctx.ellipse(b.x - b.r*0.2, b.y - b.r*0.2, b.r*0.6, b.r*0.5, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); }

      // draw entities
      entities.forEach(e=>{ 
        if(e.type==='enemy'){
          if(e.variant === 'strong') drawStrongEnemy(e);
          else if(e.variant === 'jiren') drawJiren(e);
          else if(e.variant === 'boss') drawBoss(e);
          else drawEnemy(e);
        } else if(e.type==='ally'){
          ctx.save();
          ctx.globalAlpha = 0.85;
          drawJiren(e);
          ctx.restore();
        } else if(e.type==='pickup') drawPickup(e); 
        else if(e.type==='proj'){ 
          ctx.fillStyle = ultraMode ? '#c0c0c0' : (godMode ? '#ff4757' : '#ffd86b'); 
          ctx.fillRect(e.x,e.y,e.w,e.h); 
          if(ultraMode || godMode){
            ctx.fillStyle = ultraMode ? 'rgba(192,192,192,0.3)' : 'rgba(255,71,87,0.3)';
            ctx.fillRect(e.x-2, e.y-2, e.w+4, e.h+4);
          }
        }
        else if(e.type==='super'){
          ctx.fillStyle = ultraMode ? '#e0e0e0' : (godMode ? '#ff1744' : '#ff6b35');
          ctx.fillRect(e.x,e.y,e.w,e.h);
          if(ultraMode || godMode){
            ctx.fillStyle = ultraMode ? 'rgba(224,224,224,0.4)' : 'rgba(255,23,68,0.4)';
            ctx.fillRect(e.x-4, e.y-4, e.w+8, e.h+8);
          }
        }
      });

      // draw player
      drawPlayer(player);

      // simple UI overlay
      ctx.fillStyle = 'rgba(0,0,0,0.12)'; ctx.fillRect(12,12,200,36);
      ctx.fillStyle = '#fff'; ctx.font = '14px Arial'; ctx.fillText('Shenron: the Game',20,36);
      
      // Mini game status
      if(inMiniGame){
        ctx.fillStyle = 'rgba(255,0,0,0.3)'; ctx.fillRect(W/2 - 150, 20, 300, 50);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 18px Arial';
        ctx.fillText('MINI GAME: Defeat 5 Beeruses!', W/2 - 130, 45);
        ctx.fillText('Bosses: ' + miniGameBossesKilled + '/5', W/2 - 50, 65);
      }
      
      // Ultra mini game status
      if(inUltraMiniGame){
        ctx.fillStyle = 'rgba(192,192,192,0.3)'; ctx.fillRect(W/2 - 130, 20, 260, 50);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 18px Arial';
        ctx.fillText('ULTRA GAME: Defeat Jiren!', W/2 - 110, 45);
        ctx.fillText('HP: ' + Math.max(0, Math.round(player.hp)), W/2 - 30, 65);
      }

      if(retryPending){
        ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(W/2 - 160, 80, 320, 44);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 16px Arial';
        const label = retryPending === 'ultra' ? 'ULTRA' : 'GOD';
        ctx.fillText('Press START (Enter) to retry ' + label, W/2 - 145, 108);
      }
      
      // God Mode indicator
      if(godMode && !ultraMode){
        ctx.fillStyle = 'rgba(230,57,70,0.2)'; ctx.fillRect(W - 220, 12, 200, 36);
        ctx.fillStyle = '#e63946'; ctx.font = 'bold 16px Arial';
        ctx.fillText('🔥 GOD MODE', W - 210, 36);
      }
      
      // Ultra Mode indicator
      if(ultraMode){
        ctx.fillStyle = 'rgba(192,192,192,0.25)'; ctx.fillRect(W - 220, 12, 200, 36);
        ctx.fillStyle = '#c0c0c0'; ctx.font = 'bold 16px Arial';
        ctx.fillText('⚡ ULTRA MODE', W - 210, 36);
      }

      if(ultraReady && !inUltraMiniGame){
        ctx.fillStyle = 'rgba(192,192,192,0.22)'; ctx.fillRect(W/2 - 150, 78, 300, 30);
        ctx.fillStyle = '#ffffff'; ctx.font = 'bold 14px Arial';
        ctx.fillText('JIREN MINI GAME READY', W/2 - 120, 98);
      }

      if(jirenUnlocked){
        ctx.fillStyle = 'rgba(255,255,255,0.18)'; ctx.fillRect(W - 220, 54, 200, 30);
        ctx.fillStyle = '#ffffff'; ctx.font = 'bold 14px Arial';
        ctx.fillText('JIREN READY (J)', W - 208, 74);
      }

      // flash overlay when board-clear used
      if(flashTimer > 0){
        const alpha = Math.min(0.9, flashTimer / 400);
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.fillRect(0,0,W,H);
      }
    }

    // Main loop
    function loop(ts){
      if(!lastTime) lastTime = ts; const dt = ts - lastTime; lastTime = ts;
      update(dt);
      render();
      requestAnimationFrame(loop);
    }

    // start
    resetGame();
    // seed a few enemies
    for(let i=0;i<2;i++) spawnEnemy();
    requestAnimationFrame(loop);

    // expose for debugging
    window._game = {player, entities, spawnEnemy, spawnPickup};
  })();
  </script>
</body>
</html>
